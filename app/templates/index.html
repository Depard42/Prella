<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>Prella</title>
  <link rel="manifest" href='{{ url_for("static", filename="manifest.json") }}'>
  <link rel="stylesheet" href='{{ url_for("static", filename="styles/style.css") }}'>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src='{{ url_for("static", filename="scripts/Sortable.min.js") }}'></script>
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
</head>

<body>
  
  <div class="delete" id="delete"><img src='{{ url_for("static", filename="img/trash.svg") }}'></img></div>
  <header>
    <form class="new-table-form">
      <input type="text" placeholder="Название таблички" id="table-create-input" class="input">
      <input type="submit" value="Добавить">
    </form>
    <div id="status"></div>
  </header>
  <div class="panel" id="panel">
    
    
  </div>
  <div id='error_mes'>У вас были замечены сбои в передаче данных перезагрузитесь</div>

   
  <script>
  socketio = io({
    'reconnection': true,
    'reconnectionDelay': 500,
    'maxReconnectionAttempts': Infinity
  })

  
  function newTable(id, label){
    const obj = $('<section class="tasks">'+
          ' <h3 class="tasks__title"></h3>'+
          ' <ul class="tasks__list"> </ul>'+
          ' <form class="task-create">'+
          ' <input type="text" size="18" class="inputTaskForm" placeholder="Название карточки" >'+
          ' <input type="submit" class="submitTaskForm" value="Добавить"> </form> </section>',
    ).attr('id', id);
    obj.find('.tasks__title').html(label)
                             .attr("contenteditable","true")
                             .attr("id", id)
                             .on("blur", function(event){
                                t = $(this);
                                socketio.emit('rename table', {id: t.attr('id'),
                                                               label: t.html()});
                             });
    obj.appendTo('.panel');
    obj.find('.tasks__list').attr('id', id);
    Sortable.create(obj.find('.tasks__list').get(0),{
      group: "tasklist-group",
      delay: 100,
      onEnd: changePosTask
    });

    obj.find('.task-create').on("submit", submitNewTaskForm);
  };

  function newTask(id, table_id, label){
    const obj = $('<li class="task__item">'+
                 '<p class="item__label"></p></li>')
                 .attr('id',id)
                 .attr('table_id', table_id)
    obj.find('p').html(label).attr("contenteditable","true")
                             .attr("id", id)
                             .attr("table_id", table_id)
                             .on("blur", function(event){
                                t = $(this);
                                socketio.emit('rename task', {id: t.attr('id'),
                                                              table_id: t.attr('table_id'),
                                                              label: t.html()});
                             });
    obj.appendTo('.panel #'+table_id+' .tasks__list');
  };

  function addingToDeleteBlock(event){
    event.preventDefault();
    who = $('.delete').find('section');
    
    if (who.length == 1){
      //table
      id = who.attr('id');
      socketio.emit('del table', {id: id});
    } else {
      //task
      who = $('.delete').find('li');
      id = who.attr('id');
      table_id = who.attr('table_id');
      socketio.emit('del task', {id: id, table_id: table_id});
    };
  
  };
  function changePosTable(ev){
    table_id = $(ev.item).attr('id');
    oldIndex = ev.oldDraggableIndex;
    newIndex = ev.newDraggableIndex;
    if ($(ev.to).attr('id') === "delete"){return 1;};
    if (oldIndex === newIndex){return 1;};
    socketio.emit('change index table', {
      table_id: table_id,
      oldIndex: oldIndex,
      newIndex: newIndex
    });
  };
  function changePosTask(ev){
    task_id = $(ev.item).attr('id');
    toTable = $(ev.to).attr('id');
    fromTable = $(ev.from).attr('id');
    oldIndex = ev.oldDraggableIndex;
    newIndex = ev.newDraggableIndex;
    if (toTable === "delete"){return 1;};
    if (oldIndex === newIndex){return 1;}
    socketio.emit('change index task', {
      task_id: task_id,
      oldIndex: oldIndex,
      newIndex: newIndex,
      toTable: toTable,
      fromTable: fromTable
    });
  };

  $('.new-table-form').on("submit", function(event){
    event.preventDefault();
    value = $(this).find('.input').val();
    socketio.emit('new table', {
      label: value
    });
    $(this).find('.input').val("");
  });

  function submitNewTaskForm(event){
    event.preventDefault();
    value = $(this).find('.inputTaskForm').val();
    table_id = $(this).parent().attr('id');
    socketio.emit('new task', {
      label: value,
      table_id: table_id
    });
    $(this).find('.inputTaskForm').val('');
  }

  Sortable.create($('.panel').get(0),{
    draggable: "section",
    filter: "input",
    preventOnFilter: false,
    delay: 100,
    onEnd: changePosTable
  });

  Sortable.create($('.delete').get(0),{
    group: {put: true},
    onAdd: addingToDeleteBlock
  });

  socketio.on('create table', create_table);
  function create_table(data){
    newTable(id=data['id'], label=data['label']);
  };
  socketio.on('create task', create_task);
  function create_task(data){
    newTask(id=data['id'], table_id=data['table_id'], label=data['label']);
  };
  socketio.on('delete table', delete_table);
  function delete_table(data){
    $('section#'+data['id']).detach();
  };
  socketio.on('delete task', delete_task);
  function delete_task(data){
    $('li#'+data['id']).detach();
  };
  socketio.on('rename table', rename_table);
  function rename_table(data){
    $('section#'+data['id']+" .tasks__title").html(data['label']);
  };
  socketio.on('rename task', rename_task);
  function rename_task(data){
    $('#'+data['id']+'.item__label').last().html(data['label']);
  };
  socketio.on('change index table', moveTable);
  function moveTable(data){
    table = $('#'+data['table_id']+'.tasks').detach()
    if (data['next'] == 'end'){
      table.appendTo($('.panel'))
    }
    else {
      table.insertBefore($('#'+data['next']+'.tasks'))
    }
  };
  socketio.on('change index task', moveTask);
  function moveTask(data){
    task = $('#'+data['task_id']+'.task__item').detach()
    task.attr('table_id', data['toTable']);
    task.find('p').attr('table_id', data['toTable']);
    if (data['next'] === 'end'){
      task.appendTo($('#'+data['toTable']+'.tasks__list'))
    }
    else{
      task.insertBefore($('#'+data['next']+'.task__item'))
    }
    
  };

  socketio.on('error', errorShow);
  function errorShow(){
    $('#error_mes').css('visibility', 'visible');
  };

  socketio.on('connect', function(){
    $('#status').css('background-color', 'lime');
  });
  socketio.on('disconnect', function(){
    $('#status').css('background-color', 'red');
  });

  {% for id in order %}
    newTable(id="{{ id }}", label="{{ info[id]['label'] }}");
    {% for task_id in info[id]['tasks_order'] %}
    newTask(id="{{task_id}}", table_id="{{id}}", label="{{info[id]['tasks_info'][task_id]['label']}}");
    {% endfor %}
  {% endfor %}
  </script>
  
</body>
</html>